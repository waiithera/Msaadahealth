<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot UI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2d2d2d;
            --hover-bg: #3a3a3a;
            --border-color: #404040;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-color: #5c5cff;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        .chat-area {
    flex: 1;
    padding: 32px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;  /* Change from center to flex-start */
    justify-content: flex-start; /* Change from center to flex-start */
    overflow-y: auto;
    width: 100%;
}

.message {
    max-width: 80%;
    margin-bottom: 16px;
    padding: 12px;
    border-radius: 8px;
}

.message.user {
    align-self: flex-end;
    background-color: var(--accent-color);
}

.message.bot {
    align-self: flex-start;
    background-color: var(--secondary-bg);
}
        /* Sidebar styles */
        .sidebar {
            width: 260px;
            background-color: var(--primary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

       
        .new-chat-section {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .new-chat-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            width: 100%;
            cursor: pointer;
        }

        .new-chat-button:hover {
            background-color: var(--hover-bg);
        }

        .share-button {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            margin-left: 8px;
        }

        .search-section {
            padding: 16px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            outline: none;
        }

        .no-chats {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* Main content styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

      

        .language-selector {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            outline: none;
        }

        .chat-area {
            flex: 1;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .chatbot-logo {
            width: 64px;
            height: 64px;
            background-color: var(--secondary-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .input-area {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary-bg);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            outline: none;
            padding: 8px 0;
        }

        .send-button, .help-button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .send-button:hover, .help-button:hover {
            color: var(--text-primary);
        }

       

        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
           
            .new-chat-button,
            .search-input {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                display: none;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
       

        <div class="new-chat-section">
            <div style="display: flex;">
                <button class="new-chat-button">
                    <span>+</span>
                    <span>New Chat</span>
                </button>
                <button class="share-button">
                    <i class="fas fa-share"></i>
                </button>
            </div>
        </div>

        <div class="search-section">
            <input type="text" class="search-input" placeholder="Search chats...">
        </div>

        <div class="no-chats">
            No chats.
        </div>

        
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 16px;">
                <select id="language-selector" class="language-selector">
                    <option value="en">EN</option>
                    <option value="sw">SW</option>
                    <option value="sheng">Sheng</option>
    <span id="username-display"></span>
    <button onclick="logout()" class="tool-button" style="padding: 4px 8px; border-radius: 4px;">
        <i class="fas fa-sign-out-alt"></i>
        Logout
    </button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chatbot-logo">
                <i class="fas fa-robot fa-2x"></i>
            </div>
            <h1>Msaada Health</h1>
        </div>

        <div class="input-area">
            <div class="input-container">
                <input type="text" class="message-input" placeholder="Send a message...">
                <button class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="help-button">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = localStorage.getItem('username');
    
    function checkAuth() {
        if (!currentUser) {
            window.location.href = 'login.html';
        }
        document.getElementById('username-display').textContent = currentUser;
    }
    
    function logout() {
        localStorage.removeItem('username');
        window.location.href = 'login.html';
    }
    
    checkAuth();
    
        let currentChatId = null;
        
        // Language switching functionality
        const languageSelector = document.getElementById('language-selector');
        const messages = {
            en: {
                newChat: 'New Chat',
                searchPlaceholder: 'Search chats...',
                noChats: 'No chats.',
                tools: 'Tools',
                files: 'Files',
                settings: 'Settings',
                quickSettings: 'Quick Settings',
                sendMessage: 'Send a message...',
                chatbotTitle: 'Chatbot UI'
            },
            sw: {
                newChat: 'Mazungumzo Mapya',
                searchPlaceholder: 'Tafuta mazungumzo...',
                noChats: 'Hakuna mazungumzo.',
                tools: 'Vifaa',
                files: 'Faili',
                settings: 'Mipangilio',
                quickSettings: 'Mipangilio ya Haraka',
                sendMessage: 'Tuma ujumbe...',
                chatbotTitle: 'Chatbot UI'
            },
            sheng: {
                newChat: 'Chat Mpya',
                searchPlaceholder: 'Search ma chat...',
                noChats: 'Hakuna ma chat.',
                tools: 'Tools',
                files: 'Ma File',
                settings: 'Settings',
                quickSettings: 'Quick Settings',
                sendMessage: 'Tuma message...',
                chatbotTitle: 'Chatbot UI'
            }
        };

        languageSelector.addEventListener('change', (e) => {
            const lang = e.target.value;
            updateUILanguage(lang);
        });

        function updateUILanguage(lang) {
            const texts = messages[lang];
            
            // Update all text content
            document.querySelector('.new-chat-button span:last-child').textContent = texts.newChat;
            document.querySelector('.search-input').placeholder = texts.searchPlaceholder;
            document.querySelector('.no-chats').textContent = texts.noChats;
            
            // Update tool buttons
            const toolButtons = document.querySelectorAll('.tool-button span');
            toolButtons[0].textContent = texts.tools;
            toolButtons[1].textContent = texts.files;
            toolButtons[2].textContent = texts.settings;
            
            // Update other elements
            document.querySelector('.message-input').placeholder = texts.sendMessage;
            document.querySelector('h1').textContent = texts.chatbotTitle;
        }

        const messageInput = document.querySelector('.message-input');
    const sendButton = document.querySelector('.send-button');
    const chatArea = document.querySelector('.chat-area');
    const languageSelect = document.getElementById('language-selector');
    let currentLanguage = 'en';

    // Function to create a message element
    function createMessageElement(message, isBot = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isBot ? 'bot' : 'user'}`;
    messageDiv.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas ${isBot ? 'fa-robot' : 'fa-user'}"></i>
            </div>
            <div class="ml-3">
                <p>${message}</p>
            </div>
        </div>
    `;
    return messageDiv;
}

    // Function to send message
    async function sendMessage(message) {
        try {
            if (!message.trim()) return;

            // Add user message to chat
            chatArea.appendChild(createMessageElement(message, false));

            // Clear input
            messageInput.value = '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.textContent = '...';
            chatArea.appendChild(typingDiv);

            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;

            // Send message to backend
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    language: currentLanguage
                })
            });

            // Remove typing indicator
            chatArea.removeChild(typingDiv);

            const data = await response.json();
            
            if (data.status === 'success') {
                // Add bot response to chat
                chatArea.appendChild(createMessageElement(data.response, true));
            } else {
                throw new Error(data.error || 'Failed to get response');
            }

        } catch (error) {
            console.error('Error:', error);
            chatArea.appendChild(createMessageElement('Sorry, something went wrong. Please try again.', true));
        }

        // Scroll to bottom after new message
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Event listeners
    sendButton.addEventListener('click', () => {
        sendMessage(messageInput.value);
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(messageInput.value);
        }
    });

    languageSelect.addEventListener('change', async (e) => {
        currentLanguage = e.target.value;
        try {
            const response = await fetch('/change-language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: currentLanguage })
            });
            const data = await response.json();
            if (data.status !== 'success') {
                throw new Error('Failed to change language');
            }
        } catch (error) {
            console.error('Error changing language:', error);
        }
    });
    async function initializeChat() {
    // Try to get username from localStorage or prompt user
    let username = localStorage.getItem('username');
    if (!username) {
        username = prompt('Please enter your username:');
        if (username) {
            localStorage.setItem('username', username);
        }
    }

    if (username) {
        // Login user
        const response = await fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username })
        });
        const data = await response.json();
        if (data.status === 'success') {
            await loadChats();
            await createNewChat(); // Create initial chat
        }
    }
}

// Load user's chat history
async function loadChats() {
    const response = await fetch('/get-chats');
    const data = await response.json();
    
    const chatList = document.querySelector('.chat-list');
    chatList.innerHTML = '';
    
    data.chats.forEach(chat => {
        const chatElement = document.createElement('div');
        chatElement.className = 'chat-item p-2 hover:bg-gray-700 cursor-pointer';
        chatElement.onclick = () => loadChatMessages(chat.id);
        chatElement.innerHTML = `
            <div class="flex justify-between items-center">
                <span>${chat.title}</span>
                <button onclick="deleteChat(${chat.id})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        chatList.appendChild(chatElement);
    });
}

// Create new chat
async function createNewChat() {
    const response = await fetch('/new-chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    });
    const data = await response.json();
    if (data.status === 'success') {
        currentChatId = data.chat_id;
        await loadChats();
        await loadChatMessages(currentChatId);
    }
}

// Load messages for a specific chat
async function loadChatMessages(chatId) {
    currentChatId = chatId;
    const response = await fetch(`/get-chat-messages/${chatId}`);
    const data = await response.json();
    
    chatArea.innerHTML = ''; // Clear chat area
    
    data.messages.forEach(message => {
        const messageElement = createMessageElement(message.content, message.is_bot);
        chatArea.appendChild(messageElement);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
}

// Delete chat
async function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat?')) {
        const response = await fetch(`/delete-chat/${chatId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (data.status === 'success') {
            if (currentChatId === chatId) {
                await createNewChat();
            }
            await loadChats();
        }
    }
}

// Modified sendMessage function to include chat ID
async function sendMessage(message) {
    try {
        if (!message.trim() || !currentChatId) return;

        // Add user message to chat
        chatArea.appendChild(createMessageElement(message, false));
        messageInput.value = '';

        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.textContent = '...';
        chatArea.appendChild(typingDiv);

        // Scroll to bottom
        chatArea.scrollTop = chatArea.scrollHeight;

        // Send message to backend
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                chat_id: currentChatId,
                language: currentLanguage
            })
        });

        // Remove typing indicator
        chatArea.removeChild(typingDiv);

        const data = await response.json();
        if (data.status === 'success') {
            // Add bot response to chat
            chatArea.appendChild(createMessageElement(data.response, true));
        } else {
            throw new Error(data.error || 'Failed to get response');
        }

    } catch (error) {
        console.error('Error:', error);
        chatArea.appendChild(createMessageElement('Sorry, something went wrong. Please try again.', true));
    }

    // Scroll to bottom after new message
    chatArea.scrollTop = chatArea.scrollHeight;
}

// Initialize chat when page loads
document.addEventListener('DOMContentLoaded', initializeChat);
    </script>
</body>
</html>
